<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOM ç»“æ„è°ƒè¯• - FastScrollView</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }

    .main-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      margin-bottom: 20px;
      color: #333;
    }

    #scroll-container {
      height: 600px;
      border: 2px solid #e0e0e0;
      border-radius: 4px;
      overflow: auto;
      background: #fafafa;
    }

    .list-item {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      background: white;
    }

    .debug-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .debug-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .debug-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #667eea;
      font-size: 14px;
    }

    .debug-info {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #333;
    }

    .debug-info div {
      padding: 3px 0;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
    }

    button:hover {
      background: #5568d3;
    }

    .dom-tree {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }

    .dom-node {
      padding: 2px 0;
      padding-left: 20px;
    }

    .dom-tag {
      color: #569cd6;
    }

    .dom-attr {
      color: #9cdcfe;
    }

    .dom-value {
      color: #ce9178;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-content">
      <h1>ğŸ” DOM ç»“æ„è°ƒè¯•å·¥å…·</h1>
      <div style="margin-bottom: 15px;">
        <button onclick="inspectDOM()">ğŸ” æ£€æŸ¥ DOM ç»“æ„</button>
        <button onclick="scrollToIndex(500)">è·³åˆ° #500</button>
        <button onclick="scrollToIndex(5000)">è·³åˆ° #5000</button>
        <button onclick="scrollToIndex(50000)">è·³åˆ° #50000</button>
      </div>
      <div id="scroll-container"></div>
    </div>

    <div class="debug-panel">
      <div class="debug-section">
        <div class="debug-title">ğŸ“Š å®æ—¶ç»Ÿè®¡</div>
        <div class="debug-info">
          <div>æ€»æ•°æ®: <strong id="total-items">0</strong></div>
          <div>å¯è§èŒƒå›´: <strong id="visible-range">0-0</strong></div>
          <div>åº”æ¸²æŸ“: <strong id="should-render">0</strong></div>
          <div>å®é™… DOM å…ƒç´ : <strong id="actual-dom">0</strong></div>
          <div>æ»šåŠ¨ä½ç½®: <strong id="scroll-pos">0</strong>px</div>
        </div>
        <div id="status-message"></div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸ“ å ä½ç¬¦ä¿¡æ¯</div>
        <div class="debug-info">
          <div>TopSpacer é«˜åº¦: <strong id="top-spacer">0</strong>px</div>
          <div>ContentContainer é«˜åº¦: <strong id="content-height">0</strong>px</div>
          <div>BottomSpacer é«˜åº¦: <strong id="bottom-spacer">0</strong>px</div>
          <div>ScrollContainer æ€»é«˜åº¦: <strong id="scroll-height">0</strong>px</div>
          <div>å®¹å™¨å¯è§†é«˜åº¦: <strong id="client-height">0</strong>px</div>
        </div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸŒ³ DOM æ ‘ç»“æ„</div>
        <div class="dom-tree" id="dom-tree"></div>
      </div>
    </div>
  </div>

  <script src="../dist/fast-scrollview.min.js"></script>
  <script>
    // ç”Ÿæˆæµ‹è¯•æ•°æ®
    const DATA_SIZE = 100000;
    let items = [];
    
    for (let i = 0; i < DATA_SIZE; i++) {
      items.push({
        id: i,
        title: `æ•°æ®é¡¹ ${i + 1}`,
        description: `è¿™æ˜¯ç¬¬ ${i + 1} æ¡æ•°æ®çš„æè¿°ä¿¡æ¯`
      });
    }

    // æ¸²æŸ“å‡½æ•°
    function renderItem(item, index, totalSize) {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>#${index + 1}</strong> ${item.title} - ${item.description}
      `;
      return div;
    }

    // åˆ›å»ºå®ä¾‹
    const container = document.getElementById('scroll-container');
    const fsv = new FastScrollView(
      container,
      items,
      renderItem,
      {
        estimatedItemHeight: 50,
        bufferSize: 5,
        onScroll: (info) => {
          updateDebugInfo();
        }
      }
    );

    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
    function updateDebugInfo() {
      const range = fsv.getVisibleRange();
      const actualDOMCount = container.querySelectorAll('[data-index]').length;
      const shouldRender = range.count;

      document.getElementById('total-items').textContent = items.length.toLocaleString();
      document.getElementById('visible-range').textContent = `${range.start}-${range.end}`;
      document.getElementById('should-render').textContent = shouldRender;
      document.getElementById('actual-dom').textContent = actualDOMCount;
      document.getElementById('scroll-pos').textContent = Math.round(fsv.getScrollTop());

      // è·å–å ä½ç¬¦é«˜åº¦
      const scrollContainer = container.firstChild;
      const topSpacer = scrollContainer.children[0];
      const contentContainer = scrollContainer.children[1];
      const bottomSpacer = scrollContainer.children[2];

      document.getElementById('top-spacer').textContent = topSpacer.offsetHeight;
      document.getElementById('content-height').textContent = contentContainer.offsetHeight;
      document.getElementById('bottom-spacer').textContent = bottomSpacer.offsetHeight;
      document.getElementById('scroll-height').textContent = scrollContainer.offsetHeight;
      document.getElementById('client-height').textContent = container.clientHeight;

      // æ£€æŸ¥å¼‚å¸¸
      const statusDiv = document.getElementById('status-message');
      statusDiv.innerHTML = '';
      
      if (actualDOMCount !== shouldRender) {
        statusDiv.innerHTML = `<div class="error">âš ï¸ DOM å…ƒç´ æ•°é‡ä¸åŒ¹é…ï¼åº”è¯¥: ${shouldRender}, å®é™…: ${actualDOMCount}</div>`;
      } else {
        statusDiv.innerHTML = `<div class="success">âœ… DOM å…ƒç´ æ•°é‡æ­£å¸¸</div>`;
      }

      // æ£€æŸ¥å†…å®¹å®¹å™¨æ˜¯å¦ä¸ºç©º
      if (contentContainer.children.length === 0 && shouldRender > 0) {
        statusDiv.innerHTML += `<div class="error">âš ï¸ ContentContainer ä¸ºç©ºï¼</div>`;
      }

      // æ£€æŸ¥å ä½ç¬¦æ˜¯å¦å¼‚å¸¸
      const totalSpacerHeight = topSpacer.offsetHeight + bottomSpacer.offsetHeight;
      const expectedTotal = fsv.getTotalHeight();
      if (Math.abs(totalSpacerHeight + contentContainer.offsetHeight - expectedTotal) > 100) {
        statusDiv.innerHTML += `<div class="warning">âš ï¸ å ä½ç¬¦é«˜åº¦å¯èƒ½å¼‚å¸¸</div>`;
      }
    }

    // æ£€æŸ¥ DOM ç»“æ„
    function inspectDOM() {
      const scrollContainer = container.firstChild;
      const topSpacer = scrollContainer.children[0];
      const contentContainer = scrollContainer.children[1];
      const bottomSpacer = scrollContainer.children[2];

      let html = '<div class="dom-node"><span class="dom-tag">&lt;container&gt;</span></div>';
      html += `<div class="dom-node" style="padding-left: 40px;"><span class="dom-tag">&lt;scrollContainer&gt;</span> height: ${scrollContainer.offsetHeight}px</div>`;
      html += `<div class="dom-node" style="padding-left: 60px;"><span class="dom-tag">&lt;topSpacer&gt;</span> height: <span class="dom-value">${topSpacer.offsetHeight}px</span></div>`;
      html += `<div class="dom-node" style="padding-left: 60px;"><span class="dom-tag">&lt;contentContainer&gt;</span> children: <span class="dom-value">${contentContainer.children.length}</span>, height: <span class="dom-value">${contentContainer.offsetHeight}px</span></div>`;
      
      // åˆ—å‡ºå‰5ä¸ªå’Œå5ä¸ªå­å…ƒç´ 
      const children = Array.from(contentContainer.children);
      children.slice(0, Math.min(5, children.length)).forEach((child, idx) => {
        const dataIndex = child.getAttribute('data-index');
        html += `<div class="dom-node" style="padding-left: 80px;"><span class="dom-tag">&lt;item</span> <span class="dom-attr">data-index</span>=<span class="dom-value">"${dataIndex}"</span><span class="dom-tag">&gt;</span> height: ${child.offsetHeight}px</div>`;
      });
      
      if (children.length > 10) {
        html += `<div class="dom-node" style="padding-left: 80px;color: #666;">... ${children.length - 10} ä¸ªå…ƒç´  ...</div>`;
      }
      
      children.slice(Math.max(0, children.length - 5)).forEach((child, idx) => {
        const dataIndex = child.getAttribute('data-index');
        html += `<div class="dom-node" style="padding-left: 80px;"><span class="dom-tag">&lt;item</span> <span class="dom-attr">data-index</span>=<span class="dom-value">"${dataIndex}"</span><span class="dom-tag">&gt;</span> height: ${child.offsetHeight}px</div>`;
      });

      html += `<div class="dom-node" style="padding-left: 60px;"><span class="dom-tag">&lt;bottomSpacer&gt;</span> height: <span class="dom-value">${bottomSpacer.offsetHeight}px</span></div>`;
      html += '<div class="dom-node" style="padding-left: 40px;"><span class="dom-tag">&lt;/scrollContainer&gt;</span></div>';
      html += '<div class="dom-node"><span class="dom-tag">&lt;/container&gt;</span></div>';

      document.getElementById('dom-tree').innerHTML = html;
      
      updateDebugInfo();
    }

    function scrollToIndex(index) {
      fsv.scrollToItem(index);
      setTimeout(inspectDOM, 100);
    }

    // åˆå§‹åŒ–
    setTimeout(() => {
      updateDebugInfo();
      inspectDOM();
    }, 500);

    // ç›‘å¬æ»šåŠ¨
    setInterval(updateDebugInfo, 500);
  </script>
</body>
</html>

